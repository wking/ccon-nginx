worker_processes 1;

error_log syslog:server=unix:/dev/log,facility=daemon info;

events {
	worker_connections 1024;
}

http {
	include mime.types;
	default_type application/octet-stream;

	log_format main
		'$remote_addr - $remote_user [$time_local] '
		'"$request" $status $bytes_sent '
		'"$http_referer" "$http_user_agent" '
		'"$gzip_ratio"';
	access_log syslog:server=unix:/dev/log,facility=daemon main;

	sendfile on;
	tcp_nopush on;

	gzip on;
	gzip_types application/javascript image/svg+xml text/css text/csv;

	ssl_certificate /etc/tls/chain.crt;
	ssl_certificate_key /etc/tls/key.pem;

	# wildcard server for static, single-page applications
	server {
		listen 8000 default_server ssl http2;
		listen [::]:8000 default_server ssl http2;
		server_name ~^(?<app>.+)\.example\.com$;

		root /srv/static/$app;

		location = /robots.txt {
			expires 1d;
			root /srv/robots/allow;
		}

		location ~* /(|index.html)$ {
			expires -1;
			try_files $uri /index.html;
		}

		location / {
			expires max;
			try_files $uri /index.html;
		}
	}
}
